[issue](https://github.com/hoperyy/blog/issues/41)

## 首屏自动打点原理

### 方案一：轮询

+   方案内容

    +   设定时间段：0 ~ 3s，默认 3s 时刻页面处于稳定状态
    +   以 50ms 为间隔，循环计算

        每次计算记录三个数据：
        
        （1）当前时刻首屏内的图片链接数量
        （2）当前时刻首屏内已加载的图片数量
        （3）当前时刻时间戳
        
    +   当轮训到 3s 的最后一次时

        从前到后，遍历中途所有打点数据，如果某个时刻满足下面两个条件：
        
        （1）当时首屏内的图片数量和 3s 时图片数量一致
        （2）当时已加载的图片数量大于或等于 3s 时的图片数量
        
        则认为该时刻首屏加载完毕。
    
+   缺点

    如果页面没有运行 3s 用户已离开，则首屏时间较短的那些样本会丢失，导致总体获取的首屏时间较长。
    
### 方案二：监听

+   方案内容

    （1）页面打开后，如果容器高度大于等于首屏高度，则开始监听首屏内图片加载情况
    （2）页面打开后，如果容器高度小于首屏高度，利用浏览器 API MutationObserver 监听页面容器的 DOM 变化情况。每次变化触发回调（做防抖）时，计算容器高度是否大于首屏，如果大于首屏，开始监听首屏内图片加载情况，图片加载完成，则认为首屏加载完毕。

+   缺点

    对于第（1）种情况，如果首屏的图片是通过 XHR 请求获取的，dom 中并没有呈现 img dom，则计算的时间会提前。
    
    第（2）种情况也可能有上述情况。